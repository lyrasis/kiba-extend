<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Kiba::Extend::Jobs
  
    &mdash; Kiba-Extend Documentation
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Kiba::Extend::Jobs";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (J)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Kiba.html" title="Kiba (module)">Kiba</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Extend.html" title="Kiba::Extend (module)">Extend</a></span></span>
     &raquo; 
    <span class="title">Jobs</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Kiba::Extend::Jobs
  
  
  
</h1>
<div class="box_info">
  

  
  
  <dl>
      <dt>Extended by:</dt>
      <dd><span class='object_link'><a href="Jobs/Parser.html" title="Kiba::Extend::Jobs::Parser (module)">Parser</a></span></dd>
  </dl>
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/kiba/extend/jobs.rb<span class="defines">,<br />
  lib/kiba/extend/jobs/job.rb,<br /> lib/kiba/extend/jobs/parser.rb,<br /> lib/kiba/extend/jobs/runner.rb,<br /> lib/kiba/extend/jobs/base_job.rb,<br /> lib/kiba/extend/jobs/marc_job.rb,<br /> lib/kiba/extend/jobs/reporter.rb,<br /> lib/kiba/extend/jobs/show_me_job.rb,<br /> lib/kiba/extend/jobs/tell_me_job.rb,<br /> lib/kiba/extend/jobs/job_segmenter.rb,<br /> lib/kiba/extend/jobs/dependency_job.rb,<br /> lib/kiba/extend/jobs/json_to_csv_job.rb,<br /> lib/kiba/extend/jobs/multi_source_prep_job.rb</span>
</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Reusable, composable patterns for defining, running, and testing jobs</p>

<p>There are a number of operations that need to be carried out for any job,
  depending on the format of the source and destination. For example, for
  jobs with CSV input and output, we need to:</p>

<ul>
  <li>Set up the sources, destinations, and lookups</li>
  <li>Create @srcrows and @outrows instance variables</li>
  <li>Convert CSV rows to hashes (initial transforms) prior to executing other
transformation logic</li>
  <li>Convert hashes back to CSV rows after executing transformations</li>
  <li>Calling any defined postprocessing</li>
</ul>

<p>Most of this logic never changes for jobs with the same
  input/output formats, so it is extracted here. This allows us
  to simplify the job definition modules we write in a given
  project.</p>

<h2 id="defining-jobs-in-your-project">Defining jobs in your project</h2>

<p>The simplest job definition module will consist only of a <code>:job</code>
  method, which initializes the appropriate Kiba::Extend::Jobs
  job class for the planned input/output formats.</p>

<p>Creating a new Kiba::Extend::Jobs class requires two arguments be
  provided: <code>files</code> and <code>transformer</code></p>

<h3 id="files-argument"><code>files</code> argument</h3>

<p><code>files</code> is the configuration of destination, source, and lookup
  files the job will use. It is a Hash with two required keys:
  <code>:source</code> and <code>:destination</code>. If the transformation logic refers
  to any lookup jobs, a <code>:lookup</code> key can be included.</p>

<p>The values of <code>:source</code>, <code>:destination</code>, and <code>:lookup</code> must be
  full namespaced job keys that are defined in your registry.
  You can provide an array of job keys or a single job key
  Symbol. Note that, if you provide more than one <code>:destination</code> job key,
  only the first will be used. A given job can only write to a single
  destination.</p>

<pre class="code ruby"><code class="ruby"><span class='lbrace'>{</span> <span class='label'>source:</span> <span class='lbracket'>[</span><span class='symbol'>:ns__job1</span><span class='rbracket'>]</span><span class='comma'>,</span>
   <span class='label'>destination:</span> <span class='lbracket'>[</span><span class='symbol'>:ns__job2</span><span class='comma'>,</span> <span class='symbol'>:ns__job3</span><span class='rbracket'>]</span><span class='comma'>,</span>
   <span class='label'>lookup:</span> <span class='lbracket'>[</span><span class='symbol'>:ns__job4</span><span class='comma'>,</span> <span class='symbol'>:ns__job5</span><span class='rbracket'>]</span>
<span class='rbrace'>}</span>
</code></pre>

<p>Is functionally equivalent to:</p>

<pre class="code ruby"><code class="ruby"><span class='lbrace'>{</span> <span class='label'>source:</span> <span class='symbol'>:ns__job1</span><span class='comma'>,</span>
   <span class='label'>destination:</span> <span class='symbol'>:ns__job2</span><span class='comma'>,</span>
   <span class='label'>lookup:</span> <span class='qsymbols_beg'>%i[</span><span class='tstring_content'>ns__job4</span><span class='words_sep'> </span><span class='tstring_content'>ns__job5</span><span class='tstring_end'>]</span></span>
<span class='rbrace'>}</span>
</code></pre>

<h4 id="multiple-sources">Multiple sources</h4>

<p>All rows of all sources will be read in, transformed, and written to the
  destination.</p>

<p>Writing CSV output will fail if all rows do not have the same fields. The
  Kiba::Extend::Transforms::Clean::EnsureConsistentFields transform
  can be added to the end of multi-source jobs to prevent this error.</p>

<h4 id="more-flexible-lookup-file-definition">More flexible lookup file definition</h4>

<p>Lookups defined as shown above depend upon a <code>:lookup_on</code> field being
  configured for the job in the registry.</p>

<p>What do you do if you need to use the same job (e.g.
  <code>:names__final</code>) as a lookup in different jobs, but need to
  lookup from that data on :id field in one job, and :type in
  another? If you have registered <code>:names__final</code> with
  <code>:lookup_on</code> = <code>:id</code> in your registry, you can do the
  following in the files argument setting up the job that needs
  to look up on type:</p>

<p><code>lookup: {jobkey: :names__final, lookup_on: :type}</code></p>

<p>What if you need to look up in <code>:names__final</code> by :id and :type within the
  same job?</p>

<pre class="code ruby"><code class="ruby">lookup: [
  :names__final,
  {jobkey: :names__final, lookup_on: :type, name: :names_by_type}
]
</code></pre>

<p>In the transforms for this job…</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_transform'>transform</span> <span class='const'>Merge</span><span class='op'>::</span><span class='const'>MultiRowLookup</span><span class='comma'>,</span> <span class='label'>lookup:</span> <span class='id identifier rubyid_names__final'>names__final</span>
</code></pre>

<p>…will look up on :id, and…</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_transform'>transform</span> <span class='const'>Merge</span><span class='op'>::</span><span class='const'>MultiRowLookup</span><span class='comma'>,</span> <span class='label'>lookup:</span> <span class='id identifier rubyid_names_by_type'>names_by_type</span>
</code></pre>

<p>…will look up on :type.</p>

<h3 id="transformer-argument"><code>transformer</code> argument</h3>

<p>The value of <code>transformer</code> must consist of (or, more usually,
  must return) one or more <code>Kiba.job_segment</code> blocks defining
  transformation logic.</p>

<p>In a given job definition module this usually looks like:</p>

<pre class="code ruby"><code class="ruby">def job
  Kiba::Extend::Jobs::Job.new(
    files: { ...imagine stuff here... },
    transformer: xforms
  )
end

def xforms
  Kiba.job_segment do
    transform Delete::Fields, fields: :itemtype
  end
end
</code></pre>

<p>However, you may give an array to <code>transformer</code>. The resulting
  job_segments will be included in the Job in the order you list them.
  This allows for powerful reuse of common transformation sequences
  within a project.</p>

<h2 id="some-technical-detail-partially-explaining-how-kiba-itself-creates-jobs">Some technical detail partially explaining how Kiba itself creates jobs</h2>

<p>Running <code>Kiba.parse</code> to define a job generates a
  <a href="https://github.com/thbar/kiba/blob/master/lib/kiba/control.rb" target="_parent" title="  Kiba::Control">  Kiba::Control</a>
  object, which is a wrapper bundling together: pre_processes, config,
  sources, transforms, destinations, and
  post_processes.</p>

<p>As described
  <a href="https://github.com/thbar/kiba/wiki/Implementing-pre-and-post-processors" target="_parent" title="  here">  here</a>, pre_ and post_processors get called once per ETL run—either
  before or after the ETL starts working through the source rows</p>

<p>This Kiba::Control object created by Kiba.parse is generated with a
  particular Kiba::Context, and once created, you cannot get access to or
  manipulate variables or configuration that the entire job needs to know
  about.</p>

<p>Kiba::Extend::Jobs adds the ability to set up reusable
  initial_transformers and final_transformers that go into the
  Kiba::Control object. Basically, job templates where just the
  meat of the transformations change.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'><p>2.2.0</p>
</div>
      
    </li>
  
</ul>

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="Jobs/DependencyJob.html" title="Kiba::Extend::Jobs::DependencyJob (module)">DependencyJob</a></span>, <span class='object_link'><a href="Jobs/JobSegmenter.html" title="Kiba::Extend::Jobs::JobSegmenter (module)">JobSegmenter</a></span>, <span class='object_link'><a href="Jobs/Parser.html" title="Kiba::Extend::Jobs::Parser (module)">Parser</a></span>, <span class='object_link'><a href="Jobs/Reporter.html" title="Kiba::Extend::Jobs::Reporter (module)">Reporter</a></span>, <span class='object_link'><a href="Jobs/Runner.html" title="Kiba::Extend::Jobs::Runner (module)">Runner</a></span>, <span class='object_link'><a href="Jobs/ShowMeJob.html" title="Kiba::Extend::Jobs::ShowMeJob (module)">ShowMeJob</a></span>, <span class='object_link'><a href="Jobs/TellMeJob.html" title="Kiba::Extend::Jobs::TellMeJob (module)">TellMeJob</a></span>
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="Jobs/BaseJob.html" title="Kiba::Extend::Jobs::BaseJob (class)">BaseJob</a></span>, <span class='object_link'><a href="Jobs/Job.html" title="Kiba::Extend::Jobs::Job (class)">Job</a></span>, <span class='object_link'><a href="Jobs/JsonToCsvJob.html" title="Kiba::Extend::Jobs::JsonToCsvJob (class)">JsonToCsvJob</a></span>, <span class='object_link'><a href="Jobs/MarcJob.html" title="Kiba::Extend::Jobs::MarcJob (class)">MarcJob</a></span>, <span class='object_link'><a href="Jobs/MultiSourcePrepJob.html" title="Kiba::Extend::Jobs::MultiSourcePrepJob (class)">MultiSourcePrepJob</a></span>
    
  
</p>








  
  
  
  
  
  
  <h2>Method Summary</h2>
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="Jobs/Parser.html" title="Kiba::Extend::Jobs::Parser (module)">Parser</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="Jobs/Parser.html#parse_job-instance_method" title="Kiba::Extend::Jobs::Parser#parse_job (method)">parse_job</a></span></p>


</div>

      <div id="footer">
  Generated on Thu Oct  2 21:32:11 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.1.7).
</div>

    </div>
  </body>
</html>