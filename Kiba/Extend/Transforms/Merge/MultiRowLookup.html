<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Kiba::Extend::Transforms::Merge::MultiRowLookup
  
    &mdash; Kiba-Extend Documentation
  
</title>

  <link rel="stylesheet" href="../../../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Kiba::Extend::Transforms::Merge::MultiRowLookup";
  relpath = '../../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../../../_index.html">Index (M)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../../Kiba.html" title="Kiba (module)">Kiba</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../../Extend.html" title="Kiba::Extend (module)">Extend</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Transforms.html" title="Kiba::Extend::Transforms (module)">Transforms</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Merge.html" title="Kiba::Extend::Transforms::Merge (module)">Merge</a></span></span>
     &raquo; 
    <span class="title">MultiRowLookup</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Kiba::Extend::Transforms::Merge::MultiRowLookup
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Kiba::Extend::Transforms::Merge::MultiRowLookup</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/kiba/extend/transforms/merge/multi_row_lookup.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Merge one or more rows from a <span class='object_link'><a href="../../Utils/LookupHash.html" title="Kiba::Extend::Utils::LookupHash (class)">Utils::LookupHash</a></span> into source data, matching on
  <code>keycolumn</code> values</p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="MultiRowLookup/EmptyFieldmap.html" title="Kiba::Extend::Transforms::Merge::MultiRowLookup::EmptyFieldmap (class)">EmptyFieldmap</a></span>, <span class='object_link'><a href="MultiRowLookup/LookupTypeError.html" title="Kiba::Extend::Transforms::Merge::MultiRowLookup::LookupTypeError (class)">LookupTypeError</a></span>
    
  
</p>







  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(fieldmap:, lookup:, keycolumn:, constantmap: {}, conditions: {}, multikey: false, delim: Kiba::Extend.delim, null_placeholder: nil, sorter: nil)  &#x21d2; MultiRowLookup </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A new instance of MultiRowLookup.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process-instance_method" title="#process (instance method)">#<strong>process</strong>(row)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(fieldmap:, lookup:, keycolumn:, constantmap: {}, conditions: {}, multikey: false, delim: Kiba::Extend.delim, null_placeholder: nil, sorter: nil)  &#x21d2; <tt><span class='object_link'><a href="" title="Kiba::Extend::Transforms::Merge::MultiRowLookup (class)">MultiRowLookup</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>Interaction of specifying a <code>sorter</code> and <code>multikey: true</code> may be unexpected.</p>
</div>
  </div>

<p>Returns a new instance of MultiRowLookup.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>fieldmap</span>
      
      
        <span class='type'>(<tt>Hash{Symbol =&gt; Symbol}</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>key = field in source row to merge lookup data into;
value = field from lookup table whose value maps into target field</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>lookup</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>created by Utils::LookupHash. If you have registered a job as a lookup,
kiba-extend takes care of creating this for you.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>keycolumn</span>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the field in the source data that is expected to match against the
keycolumn used to create the lookup hash. I.e. the field you will be matching on in the
<strong>source</strong> data</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>constantmap</span>
      
      
        <span class='type'>(<tt>Hash{Symbol =&gt; String}</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>constant data to map into any rows that get data
merged in from lookup table. Key = the field in source row to merge the constant value into;
value = the constant value to merge in</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>conditions</span>
      
      
        <span class='type'>(<tt>Hash</tt>, <tt>Lambda</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>logic used to select which lookup rows data should be merged
in from. The Hash option is pretty horrible and not at all documented. See the
<a href="https://github.com/lyrasis/kiba-extend/blob/main/spec/kiba/extend/utils/lookup/row_selector_by_hash_spec.rb">Lookup::RowSelectorByHash spec</a>
for some examples. The Lambda option is probably more straightforward and flexible. See
<span class='object_link'><a href="../../Utils/Lookup/RowSelectorByLambda.html" title="Kiba::Extend::Utils::Lookup::RowSelectorByLambda (class)">Utils::Lookup::RowSelectorByLambda</a></span> for examples.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>multikey</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>false</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>whether the source keycolumn should be treated as multivalued. I.e.
it will be split on the given <code>delim</code>, and each resulting element of the split array will
be used to retrieve rows from the lookup table to merge into this row</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>delim</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>Kiba::Extend.delim</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>on which to split multikey values, and to use in joining merged data in each
field if multiple lookup rows are retrieved</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>null_placeholder</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>such as <code>%NULLVALUE%</code> to merge in place of an empty/nil value.
Note that this is only used if some data is being merged into the row. That is, if no lookup
rows are found to merge in, all the target columns are left blank. This is useful mainly for
situtations where you are merging in multiple fields which can each have multiple values, and
you need to make sure groups of fields have the same number of values in them</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>sorter</span>
      
      
        <span class='type'>(<tt>nil</tt>, <tt><span class='object_link'><a href="../../Utils/Lookup/RowSorter.html" title="Kiba::Extend::Utils::Lookup::RowSorter (class)">Kiba::Extend::Utils::Lookup::RowSorter</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>handles sorting of lookup rows to control the order they
are merged in. Without specifying a sorter, the lookup data is merged in the order it appears
in the lookup table. So, if you ensure your lookup data source is sorted as desired prior to
using it in a lookup, you may not need a sorter.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/kiba/extend/transforms/merge/multi_row_lookup.rb', line 55</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>fieldmap:</span><span class='comma'>,</span> <span class='label'>lookup:</span><span class='comma'>,</span> <span class='label'>keycolumn:</span><span class='comma'>,</span> <span class='label'>constantmap:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span>
               <span class='label'>conditions:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>multikey:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>delim:</span> <span class='const'><span class='object_link'><a href="../../../../Kiba.html" title="Kiba (module)">Kiba</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../../Extend.html" title="Kiba::Extend (module)">Extend</a></span></span><span class='period'>.</span><span class='id identifier rubyid_delim'><span class='object_link'><a href="../../../Extend.html#delim-class_method" title="Kiba::Extend.delim (method)">delim</a></span></span><span class='comma'>,</span> <span class='label'>null_placeholder:</span> <span class='kw'>nil</span><span class='comma'>,</span>
               <span class='label'>sorter:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='ivar'>@fieldmap</span> <span class='op'>=</span> <span class='id identifier rubyid_fieldmap'>fieldmap</span> <span class='comment'># hash of looked-up values to merge in for each merged-in row
</span>  <span class='id identifier rubyid_fail'>fail</span> <span class='const'><span class='object_link'><a href="MultiRowLookup/EmptyFieldmap.html" title="Kiba::Extend::Transforms::Merge::MultiRowLookup::EmptyFieldmap (class)">EmptyFieldmap</a></span></span> <span class='kw'>if</span> <span class='id identifier rubyid_fieldmap'>fieldmap</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

  <span class='ivar'>@constantmap</span> <span class='op'>=</span> <span class='id identifier rubyid_constantmap'>constantmap</span> <span class='comment'># hash of constants to add for each merged-in row
</span>  <span class='ivar'>@lookup</span> <span class='op'>=</span> <span class='id identifier rubyid_lookup'>lookup</span> <span class='comment'># lookuphash; should be created with csv_to_multi_hash
</span>  <span class='id identifier rubyid_fail'>fail</span> <span class='const'><span class='object_link'><a href="MultiRowLookup/LookupTypeError.html" title="Kiba::Extend::Transforms::Merge::MultiRowLookup::LookupTypeError (class)">LookupTypeError</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="MultiRowLookup/LookupTypeError.html#initialize-instance_method" title="Kiba::Extend::Transforms::Merge::MultiRowLookup::LookupTypeError#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_lookup'>lookup</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_lookup'>lookup</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span>

  <span class='ivar'>@keycolumn</span> <span class='op'>=</span> <span class='id identifier rubyid_keycolumn'>keycolumn</span> <span class='comment'># column in main table containing value expected to be lookup key
</span>  <span class='ivar'>@multikey</span> <span class='op'>=</span> <span class='id identifier rubyid_multikey'>multikey</span> <span class='comment'># should the key be treated as multivalued
</span>  <span class='ivar'>@conditions</span> <span class='op'>=</span> <span class='id identifier rubyid_conditions'>conditions</span>
  <span class='ivar'>@delim</span> <span class='op'>=</span> <span class='id identifier rubyid_delim'>delim</span>
  <span class='ivar'>@null_placeholder</span> <span class='op'>=</span> <span class='id identifier rubyid_null_placeholder'>null_placeholder</span>
  <span class='ivar'>@sort_on</span> <span class='op'>=</span> <span class='id identifier rubyid_sort_on'>sort_on</span>
  <span class='ivar'>@sort_dir</span> <span class='op'>=</span> <span class='id identifier rubyid_sort_dir'>sort_dir</span>
  <span class='ivar'>@selector</span> <span class='op'>=</span> <span class='const'>Lookup</span><span class='op'>::</span><span class='const'>RowSelector</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span>
    <span class='label'>conditions:</span> <span class='id identifier rubyid_conditions'>conditions</span><span class='comma'>,</span>
    <span class='label'>sep:</span> <span class='id identifier rubyid_delim'>delim</span>
  <span class='rparen'>)</span>
  <span class='ivar'>@sorter</span> <span class='op'>=</span> <span class='id identifier rubyid_sorter'>sorter</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="process-instance_method">
  
    #<strong>process</strong>(row)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>row</span>
      
      
        <span class='type'>(<tt>Hash{ Symbol =&gt; String, nil }</tt>)</span>
      
      
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/kiba/extend/transforms/merge/multi_row_lookup.rb', line 80</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_field_data'>field_data</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../../../Kiba.html" title="Kiba (module)">Kiba</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../../Extend.html" title="Kiba::Extend (module)">Extend</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils.html" title="Kiba::Extend::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Fieldset.html" title="Kiba::Extend::Utils::Fieldset (class)">Fieldset</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Fieldset.html#initialize-instance_method" title="Kiba::Extend::Utils::Fieldset#initialize (method)">new</a></span></span><span class='lparen'>(</span>
    <span class='label'>fields:</span> <span class='id identifier rubyid_fieldmap'>fieldmap</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='comma'>,</span>
    <span class='label'>null_placeholder:</span> <span class='id identifier rubyid_null_placeholder'>null_placeholder</span>
  <span class='rparen'>)</span>

  <span class='id identifier rubyid_id_data'>id_data</span> <span class='op'>=</span> <span class='id identifier rubyid_row'>row</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='id identifier rubyid_keycolumn'>keycolumn</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_id_data'>id_data</span> <span class='op'>=</span> <span class='id identifier rubyid_id_data'>id_data</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span> <span class='op'>:</span> <span class='id identifier rubyid_id_data'>id_data</span>
  <span class='id identifier rubyid_ids'>ids</span> <span class='op'>=</span> <span class='id identifier rubyid_multikey'>multikey</span> <span class='op'>?</span> <span class='id identifier rubyid_id_data'>id_data</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='id identifier rubyid_delim'>delim</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_id_data'>id_data</span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_ids'>ids</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_id'>id</span><span class='op'>|</span>
    <span class='id identifier rubyid_rtm'>rtm</span> <span class='op'>=</span> <span class='id identifier rubyid_rows_to_merge'>rows_to_merge</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_field_data'>field_data</span><span class='period'>.</span><span class='id identifier rubyid_populate'>populate</span><span class='lparen'>(</span><span class='id identifier rubyid_rtm'>rtm</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_constantmap'>constantmap</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_field'>field</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
    <span class='id identifier rubyid_field_data'>field_data</span><span class='period'>.</span><span class='id identifier rubyid_add_constant_values'>add_constant_values</span><span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_field_data'>field_data</span><span class='period'>.</span><span class='id identifier rubyid_join_values'>join_values</span><span class='lparen'>(</span><span class='id identifier rubyid_delim'>delim</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_field_data'>field_data</span><span class='period'>.</span><span class='id identifier rubyid_hash'>hash</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_field'>field</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
    <span class='id identifier rubyid_row'>row</span><span class='lbracket'>[</span><span class='id identifier rubyid_target_field'>target_field</span><span class='lparen'>(</span><span class='id identifier rubyid_field'>field</span><span class='rparen'>)</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='id identifier rubyid_value'>value</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_row'>row</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Fri Jul  7 16:55:49 2023 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.34 (ruby-2.7.8).
</div>

    </div>
  </body>
</html>