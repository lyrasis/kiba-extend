<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: kiba-extend Concepts
  
    &mdash; Kiba-Extend Documentation
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "kiba_extend_concepts";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: kiba-extend Concepts</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'>
<h1 id="kiba-extend-concepts"><code>kiba-extend</code> Concepts</h1>

<h2 id="folder-structure-file-names-moduleclass-name-constants-defined-in-files">Folder structure, file names, module/class name constants defined in files</h2>

<p><code>kiba-extend</code> uses <a href="https://github.com/fxn/zeitwerk">zeitwerk</a> to automatically handle code loading, so you don’t have to manually enter <code>require_relative</code> every time you refer to code in another file. (The manual way is tedious and horrible if you end up renaming files or moving them around).</p>

<p>zeitwerk makes some strong default assumptions about folder hierarchies, file names, and constant names/namespace hierarchies defined in your code. See <a href="https://github.com/fxn/zeitwerk?tab=readme-ov-file#the-idea-file-paths-match-constant-paths">The Idea: File Paths Match Constant Paths</a>.</p>

<p>These align with the <a href="https://rubystyle.guide/#one-class-per-file">One Class per File</a> rule in the <a href="https://rubystyle.guide">Ruby Style Guide</a>, as well as the other rules in the guide pertaining to <a href="https://rubystyle.guide/#naming-conventions">Naming Conventions</a>.</p>

<p>Zeitwerk provides ways to override almost all of its default assumptions via inflectors, namespace collapsing, and techniques. See its very long README (linked above) for details. However, it’s generally easier in most projects to follow the default convention (pretty simple once you are used to it).</p>

<p><strong>Namespace collapsing example:</strong> migration-cspace-csu-base organizes its namespaced job-category module configs in <code>/lib/kiba/csu/config</code>, but collapses the config directory. See <code>setup_loader</code> in <a href="https://github.com/dts-hosting/migration-cspace-csu-base/blob/main/lib/kiba/csu.rb"><code>/lib/kiba/csu.rb</code></a>. This means I can have <code>/lib/kiba/csu/config/cleanup_prep.rb</code> defining <code>Kiba::Csu::CleanupPrep</code> config module.</p>

<p><strong>Inflections example:</strong> kiba-tms defines inflectors for dealing with some TMS tables. Generally, kiba-tms defines a config module per TMS table. For clarity, the names of the tables and the config module constants should match. For a table like <code>ClassificationXRefs</code>, I would be annoyed to have to name my file <code>classification_x_refs.rb</code> (especially since there are other tables named like: <code>ConXrefs</code>). So I added an inflector to handle this in <code>setup_loader</code> method in <code>/lib/kiba/tms.rb</code>.</p>

<h2 id="dry-configurable">dry-configurable</h2>

<p><code>kiba-extend</code> and projects based on it make heavy use of the <code>dry-configurable</code> gem to add flexible but safe config settings to control application behavior.</p>

<p>This is particularly heavily used in projects like <code>kiba-tms</code> or <code>migrations-cspace-csu-base</code> which are used as middle layers between <code>kiba-extend</code> and individual client projects.</p>

<p>However, even for one-off projects, it can be convenient to add settings for values used across your project to the main project module definition. See <a href="https://github.com/dts-hosting/migration-cspace-wpl/blob/main/lib/wpl.rb">migration-cspace-wpl</a>’s <code>:post_mig_cleanup_label</code> and <code>:photos_coll_title</code> settings as an example.</p>

<p><code>dry-configurable</code> is pretty simple. <a href="https://dry-rb.org/gems/dry-configurable/main/">Its documentation</a> is only two pages, though it leaves some important things out, such as:</p>

<ul>
  <li>Values assigned to a setting (including) <code>default</code> value must respond to <code>#freeze</code> method. You generally cannot calculate the <code>default</code> value of a setting. For example, this will raise an error:</li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_setting'>setting</span> <span class='symbol'>:indemnity_fields</span><span class='comma'>,</span>
  <span class='label'>default:</span> <span class='id identifier rubyid_fields'>fields</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_start_with?'>start_with?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ind</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='comma'>,</span>
  <span class='label'>reader:</span> <span class='kw'>true</span>
</code></pre>

<ul>
  <li>If you need to dynamically set the default value of a setting, you must provide a custom constructor instead:</li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_setting'>setting</span> <span class='symbol'>:indemnity_fields</span><span class='comma'>,</span>
  <span class='label'>default:</span> <span class='qsymbols_beg'>%i[</span><span class='tstring_end'>]</span></span><span class='comma'>,</span>
  <span class='label'>reader:</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='label'>constructor:</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_fields'>fields</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_start_with?'>start_with?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ind</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
</code></pre>
<p>A constructor is always a Proc or Lambda returning a value that can be frozen.</p>

<p>The first time <code>YourApp.indemnity_fields</code> is called from elsewhere in your code, the constructor code is called and the value is set to its result and frozen.</p>

<p>Here is a more complex example defining the <code>:note_fields</code> setting for constituent addresses in kiba-tms. It is slightly modified from reality to make a better example:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Which TMS fields should be combined into a single :address_note value
</span><span class='comment'>#   per TMS ConAddress row. Conditional logic here automatically includes
</span><span class='comment'>#   fields in this setting based on other settings.
</span><span class='id identifier rubyid_setting'>setting</span> <span class='symbol'>:note_fields</span><span class='comma'>,</span>
  <span class='label'>default:</span> <span class='qsymbols_beg'>%i[</span><span class='tstring_content'>addressnote</span><span class='tstring_end'>]</span></span><span class='comma'>,</span>
  <span class='label'>reader:</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='label'>constructor:</span> <span class='tlambda'>-&gt;</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span> <span class='tlambeg'>{</span>
    <span class='id identifier rubyid_value'>value</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:remarks</span> <span class='kw'>if</span> <span class='id identifier rubyid_migrate_remarks'>migrate_remarks</span>
    <span class='id identifier rubyid_value'>value</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:addresstypenote</span> <span class='kw'>if</span> <span class='const'>Tms</span><span class='op'>::</span><span class='const'>AddressTypes</span><span class='period'>.</span><span class='id identifier rubyid_used?'>used?</span> <span class='op'>&amp;&amp;</span>
      <span class='id identifier rubyid_address_type_handling'>address_type_handling</span> <span class='op'>==</span> <span class='symbol'>:note</span>
    <span class='id identifier rubyid_value'>value</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:addressdates</span> <span class='kw'>if</span> <span class='id identifier rubyid_dates_note'>dates_note</span>
    <span class='id identifier rubyid_value'>value</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:active</span> <span class='kw'>if</span> <span class='id identifier rubyid_migrate_inactive'>migrate_inactive</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_active_note'>active_note</span>
    <span class='qwords_beg'>%w[</span><span class='tstring_content'>billing</span><span class='words_sep'> </span><span class='tstring_content'>mailing</span><span class='words_sep'> </span><span class='tstring_content'>shipping</span><span class='tstring_end'>]</span></span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_type'>type</span><span class='op'>|</span>
      <span class='id identifier rubyid_value'>value</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_type'>type</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='kw'>if</span> <span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_type'>type</span><span class='embexpr_end'>}</span><span class='tstring_content'>_note</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_value'>value</span>
  <span class='rbrace'>}</span>
</code></pre>

<p>The <code>-&gt;(value)</code> is creating the constructor as a Lambda and passing in the setting’s <code>default</code> value as <code>value</code>. The <code>:addressnote</code> field is always treated as a note field from this table. Other fields get added to this list based on the specified criteria.</p>

<ul>
  <li>
    <p>The value of a setting defined by a constructor is set the first time the setting is called/used in the application. It is NOT recalculated on additional calls of the setting.</p>
  </li>
  <li>
    <p>The value of a setting can be overwritten at any time from anywhere. This is the principle on which kiba-tms and migrations-cspace-csu-base are based. Much of the code in a client project is dedicated to defining the correct setting values for the individual project. See everything below line 41 <a href="https://github.com/dts-hosting/migration-cspace-az_ccp/blob/main/lib/az_ccp.rb">here</a>.</p>
  </li>
  <li>
    <p>Setting values are not actually frozen until they are called. This is what allows us to do the following in a kiba-tms individual client project’s main config:</p>
  </li>
</ul>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="Kiba.html" title="Kiba (module)">Kiba</a></span></span><span class='op'>::</span><span class='const'>Tms</span><span class='op'>::</span><span class='const'>Exhibitions</span><span class='period'>.</span><span class='id identifier rubyid_delete_fields'>delete_fields</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:lightexpdaysperweek</span>
<span class='const'><span class='object_link'><a href="Kiba.html" title="Kiba (module)">Kiba</a></span></span><span class='op'>::</span><span class='const'>Tms</span><span class='op'>::</span><span class='const'>Exhibitions</span><span class='period'>.</span><span class='id identifier rubyid_delete_fields'>delete_fields</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:lightexphoursperday</span>
</code></pre>

<p>The kiba-tms and client project main configs are read in/defined before any thing else happens, so we can add some fields to be removed when we process the Exhibitions table.</p>

<p>If anything else had called <code>Kiba::Tms::Exhibitions.delete_fields</code> before this point, we’d get an error when we tried to do this.</p>

<ul>
  <li>When the value of a setting is overwritten, it looks like you can set the value to something calculated without using a contructor:</li>
</ul>

<pre class="code ruby"><code class="ruby"> <span class='const'><span class='object_link'><a href="Kiba.html" title="Kiba (module)">Kiba</a></span></span><span class='op'>::</span><span class='const'>Tms</span><span class='op'>::</span><span class='const'>Exhibitions</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_post_shape_xforms'>post_shape_xforms</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Kiba.html" title="Kiba (module)">Kiba</a></span></span><span class='period'>.</span><span class='id identifier rubyid_job_segment'><span class='object_link'><a href="Kiba/Extend/Jobs/JobSegmenter.html#job_segment-instance_method" title="Kiba::Extend::Jobs::JobSegmenter#job_segment (method)">job_segment</a></span></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_transform'>transform</span> <span class='const'>Merge</span><span class='op'>::</span><span class='const'>ConstantValueConditional</span><span class='comma'>,</span>
      <span class='label'>fieldmap:</span> <span class='lbrace'>{</span><span class='label'>exhibitionstatus:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Facility report received</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                 <span class='label'>exhibitionstatusnote:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>yes</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span>
      <span class='label'>condition:</span> <span class='tlambda'>-&gt;</span><span class='lparen'>(</span><span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span> <span class='kw'>do</span>
        <span class='op'>!</span><span class='id identifier rubyid_row'>row</span><span class='lbracket'>[</span><span class='symbol'>:text_entry</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='kw'>end</span>
    <span class='id identifier rubyid_transform'>transform</span> <span class='const'>Delete</span><span class='op'>::</span><span class='const'>Fields</span><span class='comma'>,</span> <span class='label'>fields:</span> <span class='symbol'>:text_entry</span>
  <span class='kw'>end</span>
</code></pre>

<p>Whatever’s after the <code>=</code> is evaluated first and the result of that evaluation is set as the settingvalue. The result of the <code>Kiba.job_segment</code> block is a <code>String</code>, so it can be a setting value.</p>

<h2 id="thinking-in-reusable-transformation-steps">Thinking in reusable transformation steps</h2>

<p>(todo)</p>
</div></div>

      <div id="footer">
  Generated on Thu Sep 11 00:02:32 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.1.7).
</div>

    </div>
  </body>
</html>