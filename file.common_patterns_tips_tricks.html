<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: common_patterns_tips_tricks
  
    &mdash; Kiba-Extend Documentation
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "common_patterns_tips_tricks";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: common_patterns_tips_tricks</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="common-patterns-tips-and-tricks">Common patterns, tips, and tricks</h1>

<h2 id="troubleshooting-missingdependencyerror-when-all-dependencies-are-set-up-as-expected">Troubleshooting <code>MissingDependencyError</code> when all dependencies are set up as expected</h2>

<p>Usually the cause of a <code>MissingDependencyError</code> is that a table required in some later job ends up having no rows, and thus is not written out.</p>

<p>So jobs are all set up properly, but some expected output file doesn&#39;t exist.</p>

<p>When there are no rows to write out to a Destination, we don&#39;t even know what the expected headers would have been in order to write a headers-only CSV.</p>

<p>At some point I plan to test whether jobs with no output can be made to just create a blank file, and whether that causes dependent jobs to fail in other ways.</p>

<p>For now, as of 3.3.0.150, you defend against this using the <code>Kiba::Extend::Job.output?</code> method to dynamically select only jobs having output for use as sources or lookups.</p>

<h2 id="joining-the-rows-of-multiple-sources-that-may-have-different-fields">Joining the rows of multiple sources that may have different fields</h2>

<p><strong>Works for <code>Kiba::Extend::Destinations::CSV</code> destinations only</strong></p>

<p>If you have multiple sources for a job, writing to a CSV destination will fail if all rows in all sources do not have exactly the same fields.</p>

<p>Especially when joining data from many tables, manually ensuring columns stay in sync across all sources is very tedious, especially as you are developing a set of jobs.</p>

<p>As of v2.7.0, <span class='object_link'><a href="Kiba/Extend/Utils/MultiSourceNormalizer.html" title="Kiba::Extend::Utils::MultiSourceNormalizer (class)">Kiba::Extend::Utils::MultiSourceNormalizer</a></span> and <span class='object_link'><a href="Kiba/Extend/Jobs/MultiSourcePrepJob.html" title="Kiba::Extend::Jobs::MultiSourcePrepJob (class)">Kiba::Extend::Jobs::MultiSourcePrepJob</a></span> are added to support handling this automagically.</p>

<p>See <span class='object_link'><a href="Kiba/Extend/Utils/MultiSourceNormalizer.html" title="Kiba::Extend::Utils::MultiSourceNormalizer (class)">Kiba::Extend::Utils::MultiSourceNormalizer</a></span> for full usage docs.</p>

<p>See <a href="https://github.com/lyrasis/kiba-tms/blob/main/lib/kiba/tms/jobs/in_between/name_compilation.rb">name compilation jobs in Kiba::TMS</a> for working example of use.</p>

<h2 id="using-transform-s-within-another-transform">Using transform(s) within another transform</h2>

<h3 id="aliasing-renaming-a-transform">Aliasing/renaming a transform</h3>

<p>This pattern is used with argument forwarding to deprecate/rename some transforms in kiba-extend, as shown below:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Transformer</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='op'>...</span><span class='rparen'>)</span>
    <span class='ivar'>@xform</span> <span class='op'>=</span> <span class='const'>MyOtherTransformer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>...</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_xform'>xform</span><span class='period'>.</span><span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_row'>row</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:xform</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="adding-some-extra-behavior-to-an-existing-transform-in-a-new-transform">Adding some extra behavior to an existing transform in a new transform</h3>

<p>It can also be used in order to compose additional behavior in another transform as shown below:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>NewTransformer</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>param1:</span><span class='comma'>,</span> <span class='label'>param2:</span><span class='rparen'>)</span>
    <span class='ivar'>@param1</span> <span class='op'>=</span> <span class='id identifier rubyid_param1'>param1</span>
    <span class='ivar'>@param2</span> <span class='op'>=</span> <span class='id identifier rubyid_param2'>param2</span>
    <span class='ivar'>@xform</span> <span class='op'>=</span> <span class='const'>ExistingTransformer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>opt1:</span> <span class='symbol'>:something</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span>
    <span class='comment'># do stuff to row
</span>    <span class='id identifier rubyid_xform'>xform</span><span class='period'>.</span><span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span>
    <span class='comment'># do more stuff to row
</span>    <span class='id identifier rubyid_row'>row</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:param1</span><span class='comma'>,</span> <span class='symbol'>:param2</span><span class='comma'>,</span> <span class='symbol'>:xform</span>
<span class='kw'>end</span>
</code></pre>

<p>See the code for <span class='object_link'><a href="Kiba/Extend/Transforms/Rename/Fields.html" title="Kiba::Extend::Transforms::Rename::Fields (class)">Kiba::Extend::Transforms::Rename::Fields</a></span> for a simple example of embedding another transform to compose transformation logic.</p>

<p>See <span class='object_link'><a href="Kiba/Extend/Transforms/Collapse/FieldsToRepeatableFieldGroup.html" title="Kiba::Extend::Transforms::Collapse::FieldsToRepeatableFieldGroup (class)">Kiba::Extend::Transforms::Collapse::FieldsToRepeatableFieldGroup</a></span> for a complex example, involving many other transforms.</p>

<h3 id="chaining-multiple-transforms-in-another-transform">Chaining multiple transforms in another transform</h3>

<p>You can do:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>NewTransformer</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='op'>...</span><span class='rparen'>)</span>
    <span class='ivar'>@xforms</span> <span class='op'>=</span> <span class='lbracket'>[</span>
      <span class='const'>ExitingTransformer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>...</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='const'>AnotherTransformer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>...</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='const'>ThirdTransformer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>...</span><span class='rparen'>)</span>
    <span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='comment'># @private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_xforms'>xforms</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_xform'>xform</span><span class='op'>|</span> <span class='id identifier rubyid_xform'>xform</span><span class='period'>.</span><span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_row'>row</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:xforms</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="limitations-on-the-above">LIMITATIONS ON THE ABOVE</h3>

<p>All of the above patterns should work with normal transforms---those that process one row at a time and always return that row.</p>

<p>Be careful including the following types of transforms in any of the above patterns:</p>

<ul>
<li><strong>Transforms that sometimes return the row and sometimes return nil.</strong> Example: all the <span class='object_link'><a href="Kiba/Extend/Transforms/FilterRows.html" title="Kiba::Extend::Transforms::FilterRows (module)">Kiba::Extend::Transforms::FilterRows</a></span> transforms.</li>
<li><strong>Transforms that can output more than one row from a given input row.</strong> The <code>:process</code> method of such transforms will <code>yield</code> rows and return <code>nil</code>. Example: <span class='object_link'><a href="Kiba/Extend/Transforms/Explode/RowsFromMultivalField.html" title="Kiba::Extend::Transforms::Explode::RowsFromMultivalField (class)">Kiba::Extend::Transforms::Explode::RowsFromMultivalField</a></span></li>
<li><strong>Transforms that work on multiple rows (or the whole table) at a time</strong> Such transforms will have a <code>:close</code> method that returns or yields rows. The <code>:process</code> method of such transforms will generally push rows to an accumulator Array or Hash defined as a class instance variable, and return <code>nil</code>. The <code>:close</code> method typically operates on the contents of the accumulator once all rows have been pushed into it. Example: <span class='object_link'><a href="Kiba/Extend/Transforms/Deduplicate/Table.html" title="Kiba::Extend::Transforms::Deduplicate::Table (class)">Kiba::Extend::Transforms::Deduplicate::Table</a></span></li>
</ul>

<h2 id="using-transforms-in-job-definitions">Using transforms in job definitions</h2>

<p>The following code snippets are equivalent.</p>

<p>This one relies on the domain specific language (DSL) &quot;magic&quot; defined in kiba:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="Kiba.html" title="Kiba (module)">Kiba</a></span></span><span class='period'>.</span><span class='id identifier rubyid_job_segment'><span class='object_link'><a href="Kiba/Extend/Jobs/JobSegmenter.html#job_segment-instance_method" title="Kiba::Extend::Jobs::JobSegmenter#job_segment (method)">job_segment</a></span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_transform'>transform</span> <span class='const'>Merge</span><span class='op'>::</span><span class='const'>ConstantValue</span><span class='comma'>,</span> <span class='label'>target:</span> <span class='symbol'>:data_source</span><span class='comma'>,</span> <span class='label'>value:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>source system</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>This one uses plain Ruby to set up the transform class and calls its <code>:process</code> method on each row:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="Kiba.html" title="Kiba (module)">Kiba</a></span></span><span class='period'>.</span><span class='id identifier rubyid_job_segment'><span class='object_link'><a href="Kiba/Extend/Jobs/JobSegmenter.html#job_segment-instance_method" title="Kiba::Extend::Jobs::JobSegmenter#job_segment (method)">job_segment</a></span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_xform'>xform</span> <span class='op'>=</span> <span class='const'>Merge</span><span class='op'>::</span><span class='const'>ConstantValue</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>target:</span> <span class='symbol'>:data_source</span><span class='comma'>,</span> <span class='label'>value:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>source system</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_transform'>transform</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_row'>row</span><span class='op'>|</span> <span class='id identifier rubyid_xform'>xform</span><span class='period'>.</span><span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<p>The second one might be useful in situations when you are trying to set things up more flexibly.</p>

<h2 id="calling-a-job-with-parameters">Calling a job with parameters</h2>

<p>No need to write repetitive jobs with the exact same logic to handle variable values that differ according to a pattern. See <a href="https://lyrasis.github.io/kiba-extend/file.file_registry_entry.html#hash-creator-example-since-2-7-2">File registry documentation on Hash creator</a> for a full example of how to do this.</p>

<h2 id="automating-repetitive-file-registry">Automating repetitive file registry</h2>

<p>The basic idea of this is:</p>

<ul>
<li>write code that generates <code>Project.registry</code> <code>register</code> commands with registry keys and hashes, according to the necessary pattern.</li>
<li>call this code from within <code>Project::RegistryData.register</code> before <code>register_files</code> is called.</li>
</ul>

<p>One pattern for doing this is publicly viewable <a href="https://github.com/lyrasis/csws-update/blob/main/lib/csws/registry_data.rb#L7-L15">in the <code>kiba-tms</code> project</a>. <code>register_supplied_files</code> automates registry of the original TMS CSV files included in the project. <code>register_prep_files</code> automates the creation of entries for all original files into a <code>prep</code> namespace. If a custom prep method or module has been creating matching the name pattern, it will be used as the creator. Otherwise, the creator will be <a href="https://github.com/lyrasis/kiba-tms/blob/main/lib/kiba/tms/jobs/abstract_prep.rb"><code>Kiba::Tms::Jobs::AbstractPrep</code></a>, which removes TMS-specific fields and deletes any empty fields.</p>

<p>Another example (in LYRASIS private repo) is <a href="https://github.com/lyrasis/csws-update/blob/main/lib/csws/registry_data.rb#L7-L15">here</a>.</p>

<h2 id="running-jobs-and-checking-srcrows-and-outrows-counts-from-client-project-code">Running jobs, and checking <code>srcrows</code> and <code>outrows</code> counts from client project code</h2>

<p>Since 3.1.0, you can do this from any project using <code>kiba-extend</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_job'>job</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Kiba.html" title="Kiba (module)">Kiba</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Kiba/Extend.html" title="Kiba::Extend (module)">Extend</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Kiba/Extend/Command.html" title="Kiba::Extend::Command (module)">Command</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Kiba/Extend/Command/Run.html" title="Kiba::Extend::Command::Run (module)">Run</a></span></span><span class='period'>.</span><span class='id identifier rubyid_job'><span class='object_link'><a href="Kiba/Extend/Command/Run.html#job-class_method" title="Kiba::Extend::Command::Run.job (method)">job</a></span></span><span class='lparen'>(</span><span class='symbol'>:prep__objects</span><span class='rparen'>)</span>
<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Some records omitted</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_outrows'>outrows</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_srcrows'>srcrows</span>
</code></pre>

<p>This assumes <code>:prep__objects</code> is registered as a job.</p>

<p>This is being used in the publicly available <code>kiba-tms</code> project, in the auto-config generation and to-do check processes. <a href="https://github.com/lyrasis/kiba-tms/search?q=Kiba%3A%3AExtend%3A%3ACommand%3A%3ARun.job">Examples</a></p>
</div></div>

      <div id="footer">
  Generated on Fri May 19 00:14:56 2023 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.34 (ruby-2.7.8).
</div>

    </div>
  </body>
</html>